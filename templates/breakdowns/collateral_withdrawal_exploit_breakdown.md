# Liquidation Vulnerability: Profitable User Withdraws All Collateral Removing Liquidation Incentive

## Vulnerability Overview

This vulnerability occurs when users with profitable leveraged positions can withdraw their deposited collateral while remaining solvent, removing liquidation incentives for liquidators. When the position's profitability reverses, there may be insufficient collateral to seize, leading to bad debt accumulation.

### Key Indicators in Contracts
- **Withdrawal Functions**: `withdraw()`, `withdrawCollateral()` functions without minimum collateral retention checks
- **PNL Calculations**: Functions that calculate profit/loss but don't enforce minimum collateral for open positions
- **Collateral Valuation**: Missing checks ensuring users maintain minimum collateral despite positive PNL
- **Position Closure**: Functions allowing complete collateral withdrawal while positions remain open

### Impact
- Liquidators receive insufficient collateral when liquidating reversed positions
- Protocol accumulates bad debt from profitable positions that become insolvent
- Economic attacks where users profit from position reversals without risk
- Reduced liquidation participation due to insufficient incentives

## Query Stages

The Glider query implements a 4-stage detection process:

### Stage 1: Function Collection
- Collects public/external functions excluding constructors and view/pure functions
- Focuses on withdrawal and position management functions
- Limits to 20,000 functions for performance

### Stage 2: Withdrawal Function Identification
- Matches function signatures against withdrawal patterns: `withdraw`, `withdrawCollateral`, `removeCollateral`
- Uses case-insensitive regex matching on function names
- Verifies functions involve collateral movement

### Stage 3: Collateral Retention Analysis
- **PNL Integration Check**: Verifies if collateral valuation includes current position profitability
- **Minimum Collateral Enforcement**: Checks for minimum collateral requirements despite positive PNL
- **Position State Validation**: Ensures withdrawal functions validate position health

### Stage 4: Vulnerability Scoring
- **High Risk**: Withdrawal functions without minimum collateral checks
- **Medium Risk**: Functions with PNL calculations but insufficient collateral enforcement
- **Low Risk**: Functions with proper collateral retention mechanisms
- Filters results with score â‰¥6, limits to 200 unique functions

## Optimization Focus

### API-First Design
- **Declarative Filtering**: Uses `.filter()` with lambdas for early elimination
- **Glider APIs**: Relies on `callee_functions()`, `instructions()`, `state_variables()` instead of `source_code()` parsing
- **Helper Functions**: Extracts checks into reusable functions for readability

### Performance Optimizations
- **Early Exits**: Cheap signature-based checks before expensive API calls
- **Execution Limits**: Sets reasonable `.exec()` limits (50 for callees, 200 for instructions)
- **Deduplication**: Uses function string representation as keys

### Accuracy Enhancements
- **Semantic Analysis**: Leverages Glider's query system for precise detection
- **Comprehensive Coverage**: Checks both explicit collateral checks and PNL integration
- **False Positive Reduction**: Penalizes functions with proper validation

### References
- **Glider Cheatsheet**: Follows API-first approaches and limit-setting best practices
- **Performance Patterns**: Mirrors optimization strategies from reference implementations
- **Detection Logic**: Balances efficiency with thoroughness for zero false negatives
